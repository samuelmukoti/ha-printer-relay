<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RelayPrint</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="static/styles.css">
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <header class="app-header">
      <div class="app-title">
        <svg viewBox="0 0 24 24">
          <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
        </svg>
        <h1>RelayPrint</h1>
        <!-- Remote Access Status Badge -->
        <div class="tunnel-status" id="tunnel-status" onclick="showTunnelDetails()" title="Click for details">
          <div class="tunnel-indicator loading" id="tunnel-indicator"></div>
          <span class="tunnel-label" id="tunnel-label">Checking...</span>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="refreshAll()">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
          </svg>
          Refresh
        </button>
      </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="nav-tabs">
      <button class="nav-tab active" data-tab="dashboard">Dashboard</button>
      <button class="nav-tab" data-tab="printers">Printers</button>
      <button class="nav-tab" data-tab="discover">Discover</button>
      <button class="nav-tab" data-tab="queue">Print Queue</button>
      <button class="nav-tab" data-tab="settings">Settings</button>
    </nav>

    <!-- Dashboard Tab -->
    <section id="dashboard" class="tab-content active">
      <div class="status-grid">
        <div class="status-card">
          <div class="icon primary">
            <svg viewBox="0 0 24 24">
              <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
            </svg>
          </div>
          <div class="value" id="printer-count">-</div>
          <div class="label">Connected Printers</div>
        </div>
        <div class="status-card">
          <div class="icon success">
            <svg viewBox="0 0 24 24">
              <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
            </svg>
          </div>
          <div class="value" id="completed-jobs">-</div>
          <div class="label">Completed Today</div>
        </div>
        <div class="status-card">
          <div class="icon warning">
            <svg viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
          </div>
          <div class="value" id="pending-jobs">-</div>
          <div class="label">Pending Jobs</div>
        </div>
        <!-- Remote Access Status Card -->
        <div class="status-card" id="remote-status-card" onclick="showTunnelDetails()" style="cursor:pointer;">
          <div class="icon" id="remote-icon">
            <svg viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
            </svg>
          </div>
          <div class="value" id="remote-status-value" style="font-size:16px;">Checking...</div>
          <div class="label" id="remote-status-label">Remote Access</div>
        </div>
      </div>

      <!-- Recent Printers -->
      <div class="card">
        <div class="card-header">
          <div>
            <h2 class="card-title">Connected Printers</h2>
            <p class="card-subtitle">Printers available for mobile printing</p>
          </div>
          <button class="btn btn-primary" onclick="showTab('discover')">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
            </svg>
            Add Printer
          </button>
        </div>
        <div id="dashboard-printers" class="printer-list">
          <div class="loading-overlay">
            <div class="spinner"></div>
            <span>Loading printers...</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Printers Tab -->
    <section id="printers" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div>
            <h2 class="card-title">All Printers</h2>
            <p class="card-subtitle">Manage your connected printers</p>
          </div>
        </div>
        <div id="all-printers" class="printer-list">
          <div class="loading-overlay">
            <div class="spinner"></div>
            <span>Loading printers...</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Discover Tab -->
    <section id="discover" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div>
            <h2 class="card-title">Discover Network Printers</h2>
            <p class="card-subtitle">Find printers on your local network</p>
          </div>
          <button class="btn btn-primary" onclick="scanForPrinters()" id="scan-btn">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
            Scan Network
          </button>
        </div>
        <div id="discovered-printers" class="discovered-printers">
          <div class="empty-state">
            <svg viewBox="0 0 24 24">
              <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
            <h3>No printers discovered yet</h3>
            <p>Click "Scan Network" to search for printers on your local network</p>
          </div>
        </div>
      </div>

      <!-- Manual Add -->
      <div class="card" style="margin-top: 24px;">
        <div class="card-header">
          <div>
            <h2 class="card-title">Add Printer Manually</h2>
            <p class="card-subtitle">Enter printer details if auto-discovery doesn't find it</p>
          </div>
        </div>
        <form id="manual-add-form" onsubmit="addPrinterManually(event)">
          <div class="form-group">
            <label class="form-label" for="printer-uri">Printer URI</label>
            <input type="text" id="printer-uri" class="form-input" placeholder="ipp://192.168.1.100:631/ipp/print" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="printer-name">Printer Name</label>
            <input type="text" id="printer-name" class="form-input" placeholder="My Printer" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="printer-location">Location (optional)</label>
            <input type="text" id="printer-location" class="form-input" placeholder="Office">
          </div>
          <button type="submit" class="btn btn-success">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
            </svg>
            Add Printer
          </button>
        </form>
      </div>
    </section>

    <!-- Queue Tab -->
    <section id="queue" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div>
            <h2 class="card-title">Print Queue</h2>
            <p class="card-subtitle">Active and recent print jobs</p>
          </div>
          <button class="btn btn-secondary" onclick="loadQueue()">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
            </svg>
            Refresh
          </button>
        </div>
        <div id="print-queue" class="queue-list">
          <div class="empty-state">
            <svg viewBox="0 0 24 24">
              <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
            </svg>
            <h3>No print jobs</h3>
            <p>Print jobs from the mobile app will appear here</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Settings Tab -->
    <section id="settings" class="tab-content">
      <!-- Remote Access Card -->
      <div class="card">
        <div class="card-header">
          <div>
            <h2 class="card-title">
              <svg viewBox="0 0 24 24" fill="currentColor" style="width:24px;height:24px;vertical-align:middle;margin-right:8px;">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
              </svg>
              Remote Access
            </h2>
            <p class="card-subtitle">Print from anywhere with your mobile app</p>
          </div>
          <div class="tunnel-status-badge" id="settings-tunnel-status">
            <span class="status-dot" id="settings-status-dot"></span>
            <span id="settings-status-text">Checking...</span>
          </div>
        </div>

        <!-- Status Banner -->
        <div class="settings-banner" id="tunnel-banner">
          <div class="banner-icon" id="banner-icon">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
            </svg>
          </div>
          <div class="banner-content">
            <div class="banner-title" id="banner-title">Remote Access Disabled</div>
            <div class="banner-text" id="banner-text">
              Enable to access RelayPrint from your mobile app anywhere in the world.
            </div>
          </div>
        </div>

        <!-- Simple Enable Toggle -->
        <div class="settings-section">
          <form id="cloudflare-config-form" onsubmit="saveCloudflareConfig(event)">
            <div class="quick-tunnel-card">
              <div class="quick-tunnel-header">
                <div class="quick-tunnel-info">
                  <div class="quick-tunnel-title">
                    <svg viewBox="0 0 24 24" fill="currentColor" style="width:20px;height:20px;">
                      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                    </svg>
                    Enable Remote Access
                  </div>
                  <div class="quick-tunnel-desc">
                    One-click setup via Cloudflare Quick Tunnel (no account needed)
                  </div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="cf-enabled" name="enabled" onchange="onTunnelToggle()">
                  <span class="toggle-slider"></span>
                </label>
              </div>

              <!-- URL Display (shown when active) -->
              <div class="tunnel-url-display" id="tunnel-url-display" style="display:none;">
                <div class="tunnel-url-label">Your Public URL:</div>
                <div class="tunnel-url-box">
                  <code id="tunnel-url-value">Loading...</code>
                  <button type="button" class="btn btn-icon btn-secondary" onclick="copyTunnelUrl()" title="Copy URL">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                    </svg>
                  </button>
                </div>
                <div class="tunnel-url-hint">
                  <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                  </svg>
                  URL changes when addon restarts. Mobile app auto-discovers it.
                </div>
              </div>
            </div>

            <div class="form-actions" style="margin-top:16px;">
              <button type="submit" class="btn btn-primary" id="save-config-btn">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                </svg>
                Apply Changes
              </button>
            </div>
          </form>
        </div>

        <!-- Advanced Options (collapsed by default) -->
        <div class="settings-section" style="border-bottom:none; padding-bottom:0;">
          <div class="section-header" onclick="toggleSection('advanced-options')">
            <h3>
              <svg viewBox="0 0 24 24" fill="currentColor" style="width:20px;height:20px;vertical-align:middle;margin-right:8px;">
                <path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
              </svg>
              Advanced: Custom Domain (Optional)
            </h3>
            <svg class="expand-chevron" id="chevron-advanced-options" viewBox="0 0 24 24" fill="currentColor">
              <path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"/>
            </svg>
          </div>
          <div class="section-content" id="advanced-options">
            <p class="advanced-hint">
              Want a permanent custom URL? Create a Cloudflare account and named tunnel.
            </p>
            <div class="form-group">
              <label class="form-label" for="cf-token">
                Tunnel Token
                <span class="form-hint">From Cloudflare Zero Trust â†’ Tunnels</span>
              </label>
              <div class="input-with-action">
                <input type="password" id="cf-token" name="tunnel_token" class="form-input" 
                       placeholder="eyJhIjoiNmU4ZDU3Y..." autocomplete="off">
                <button type="button" class="btn btn-icon btn-secondary" onclick="toggleTokenVisibility()" title="Show/Hide">
                  <svg id="token-eye-icon" viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                  </svg>
                </button>
              </div>
            </div>

            <!-- Setup link -->
            <div class="setup-link">
              <a href="https://one.dash.cloudflare.com" target="_blank" rel="noopener">
                <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                  <path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/>
                </svg>
                Open Cloudflare Zero Trust Dashboard
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- About Card -->
      <div class="card" style="margin-top: 24px;">
        <div class="card-header">
          <div>
            <h2 class="card-title">About RelayPrint</h2>
            <p class="card-subtitle">Version and system information</p>
          </div>
        </div>
        <div class="about-info">
          <div class="about-row">
            <span class="about-label">Version</span>
            <span class="about-value" id="about-version">-</span>
          </div>
          <div class="about-row">
            <span class="about-label">API Port</span>
            <span class="about-value">7779</span>
          </div>
          <div class="about-row">
            <span class="about-label">CUPS Port</span>
            <span class="about-value">631</span>
          </div>
          <div class="about-row">
            <span class="about-label">Documentation</span>
            <span class="about-value">
              <a href="https://github.com/samuelmukoti/ha-printer-relay" target="_blank" rel="noopener">GitHub</a>
            </span>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>

  <!-- Add Printer Modal -->
  <div class="modal-overlay" id="add-printer-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add Printer</h3>
        <button class="modal-close" onclick="closeModal('add-printer-modal')">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
      </div>
      <div class="modal-body" id="add-printer-modal-body">
        <!-- Dynamic content -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('add-printer-modal')">Cancel</button>
        <button class="btn btn-success" id="confirm-add-printer">Add Printer</button>
      </div>
    </div>
  </div>

  <script>
    // Tab Navigation
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        showTab(tab.dataset.tab);
      });
    });

    function showTab(tabId) {
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
      document.getElementById(tabId).classList.add('active');

      // Load data for the tab
      if (tabId === 'queue') loadQueue();
      if (tabId === 'settings') loadSettingsTab();
    }

    // Toast Notifications
    function showToast(type, title, message) {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;

      const icons = {
        success: '<path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>',
        error: '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>',
        info: '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>'
      };

      toast.innerHTML = `
        <svg class="toast-icon" viewBox="0 0 24 24">${icons[type]}</svg>
        <div class="toast-content">
          <div class="toast-title">${title}</div>
          <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
      `;

      container.appendChild(toast);
      setTimeout(() => toast.remove(), 5000);
    }

    // Modal functions
    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // API Functions
    async function fetchAPI(endpoint, options = {}) {
      try {
        const response = await fetch(`api${endpoint}`, {
          headers: { 'Content-Type': 'application/json', ...options.headers },
          ...options
        });
        return await response.json();
      } catch (error) {
        console.error('API Error:', error);
        throw error;
      }
    }

    // Load Printers
    async function loadPrinters() {
      try {
        const data = await fetchAPI('/printers');
        const printers = data.printers || [];

        document.getElementById('printer-count').textContent = printers.length;

        const renderPrinterList = (containerId, showActions = true) => {
          const container = document.getElementById(containerId);

          if (printers.length === 0) {
            container.innerHTML = `
              <div class="empty-state">
                <svg viewBox="0 0 24 24">
                  <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
                </svg>
                <h3>No printers connected</h3>
                <p>Add a printer to start printing from your mobile device</p>
                <button class="btn btn-primary" onclick="showTab('discover')">Discover Printers</button>
              </div>
            `;
            return;
          }

          container.innerHTML = printers.map(printer => {
            const stateClass = printer.state === 3 ? 'online' : (printer.state === 5 ? 'offline' : 'idle');
            const stateText = printer.state === 3 ? 'Ready' : (printer.state === 5 ? 'Offline' : 'Idle');

            return `
              <div class="printer-item">
                <div class="printer-icon">
                  <svg viewBox="0 0 24 24">
                    <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
                  </svg>
                </div>
                <div class="printer-info">
                  <div class="printer-name">${printer.name}</div>
                  <div class="printer-model">${printer.make_model || 'Unknown Model'}</div>
                </div>
                <div class="printer-status">
                  <span class="status-indicator ${stateClass}"></span>
                  <span class="status-text">${stateText}</span>
                </div>
                ${showActions ? `
                  <div class="printer-actions">
                    <button class="btn btn-icon btn-secondary" onclick="testPrint('${printer.name}')" title="Test Print">
                      <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                        <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
                      </svg>
                    </button>
                    <button class="btn btn-icon btn-danger" onclick="removePrinter('${printer.name}')" title="Remove">
                      <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                      </svg>
                    </button>
                  </div>
                ` : ''}
              </div>
            `;
          }).join('');
        };

        renderPrinterList('dashboard-printers', false);
        renderPrinterList('all-printers', true);

      } catch (error) {
        showToast('error', 'Error', 'Failed to load printers');
      }
    }

    // Load Queue
    async function loadQueue() {
      try {
        const data = await fetchAPI('/queue/status');
        const jobs = data.jobs || [];

        document.getElementById('pending-jobs').textContent = data.pending || 0;
        document.getElementById('completed-jobs').textContent = data.completed || 0;

        const container = document.getElementById('print-queue');

        if (jobs.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <svg viewBox="0 0 24 24">
                <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
              </svg>
              <h3>No print jobs</h3>
              <p>Print jobs from the mobile app will appear here</p>
            </div>
          `;
          return;
        }

        container.innerHTML = jobs.map(job => `
          <div class="queue-item">
            <div class="job-info">
              <div class="job-name">${job.title || 'Untitled'}</div>
              <div class="job-details">${job.printer} - ${job.pages || '?'} pages</div>
            </div>
            <span class="job-status ${job.state}">${job.state}</span>
            ${job.state === 'pending' || job.state === 'printing' ? `
              <button class="btn btn-icon btn-secondary" onclick="cancelJob(${job.id})" title="Cancel">
                <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                  <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
              </button>
            ` : ''}
          </div>
        `).join('');

      } catch (error) {
        document.getElementById('pending-jobs').textContent = '-';
        document.getElementById('completed-jobs').textContent = '-';
      }
    }

    // Scan for Printers
    async function scanForPrinters() {
      const btn = document.getElementById('scan-btn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner" style="width:18px;height:18px;border-width:2px;"></div> Scanning...';

      const container = document.getElementById('discovered-printers');
      container.innerHTML = `
        <div class="loading-overlay">
          <div class="spinner"></div>
          <span>Scanning network for printers...</span>
        </div>
      `;

      try {
        const data = await fetchAPI('/discover');
        const printers = data.printers || [];

        if (printers.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <svg viewBox="0 0 24 24">
                <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
              </svg>
              <h3>No new printers found</h3>
              <p>Make sure your printer is on and connected to the network, then try scanning again</p>
            </div>
          `;
        } else {
          container.innerHTML = printers.map((printer, index) => {
            const protocols = printer.protocols || [];
            const hasMultipleProtocols = protocols.length > 1;
            const recommendedProtocol = protocols.find(p => p.secure) || protocols[0];

            return `
            <div class="discovered-printer" id="printer-card-${index}">
              <div class="printer-card-header" onclick="togglePrinterDetails(${index})">
                <div style="display:flex;align-items:center;flex:1;">
                  <div class="printer-icon">
                    <svg viewBox="0 0 24 24">
                      <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
                    </svg>
                  </div>
                  <div class="printer-info">
                    <div class="printer-name">${printer.name || 'Network Printer'}</div>
                    <div class="printer-model">${printer.address}${hasMultipleProtocols ? ` â€¢ ${protocols.length} protocols available` : ''}</div>
                  </div>
                </div>
                <svg class="expand-icon" id="expand-icon-${index}" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                  <path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"/>
                </svg>
              </div>

              <div class="printer-details" id="printer-details-${index}" style="display:none;">
                <div class="printer-detail-row">
                  <span class="detail-label">IP Address</span>
                  <span class="detail-value">${printer.address}</span>
                </div>
                ${printer.hostname ? `
                <div class="printer-detail-row">
                  <span class="detail-label">Hostname</span>
                  <span class="detail-value">${printer.hostname}</span>
                </div>
                ` : ''}

                <div class="protocol-section">
                  <span class="detail-label">Available Protocols</span>
                  <div class="protocol-options">
                    ${protocols.map((protocol, pIndex) => `
                      <label class="protocol-option ${pIndex === 0 || protocol.secure ? 'recommended' : ''}">
                        <input type="radio" name="protocol-${index}" value="${pIndex}" ${(protocol.secure || pIndex === 0) ? 'checked' : ''}>
                        <div class="protocol-info">
                          <span class="protocol-type">
                            ${protocol.secure ? 'ðŸ”’ ' : ''}${protocol.type}
                            ${protocol.secure ? '<span class="badge secure">Secure</span>' : ''}
                            ${pIndex === 0 && protocols.length > 1 && !protocol.secure ? '<span class="badge">Default</span>' : ''}
                          </span>
                          <span class="protocol-uri">${protocol.uri}</span>
                          <span class="protocol-port">Port: ${protocol.port}</span>
                        </div>
                      </label>
                    `).join('')}
                  </div>
                </div>
              </div>

              <button class="btn btn-success" style="width:100%;margin-top:12px;" onclick="addDiscoveredPrinterWithProtocol(${index}, '${encodeURIComponent(JSON.stringify(printer))}')">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
                Add to RelayPrint
              </button>
            </div>
          `}).join('');

          showToast('success', 'Scan Complete', `Found ${printers.length} printer(s)`);
        }
      } catch (error) {
        container.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
            </svg>
            <h3>Scan failed</h3>
            <p>Unable to scan network. Please try again.</p>
          </div>
        `;
        showToast('error', 'Error', 'Failed to scan for printers');
      }

      btn.disabled = false;
      btn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
        </svg>
        Scan Network
      `;
    }

    // Toggle printer details visibility
    function togglePrinterDetails(index) {
      const details = document.getElementById(`printer-details-${index}`);
      const icon = document.getElementById(`expand-icon-${index}`);
      const isHidden = details.style.display === 'none';

      details.style.display = isHidden ? 'block' : 'none';
      icon.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
    }

    // Add printer with selected protocol
    async function addDiscoveredPrinterWithProtocol(index, encodedPrinter) {
      const printer = JSON.parse(decodeURIComponent(encodedPrinter));
      const protocols = printer.protocols || [];

      // Get selected protocol
      const selectedRadio = document.querySelector(`input[name="protocol-${index}"]:checked`);
      const protocolIndex = selectedRadio ? parseInt(selectedRadio.value) : 0;
      const selectedProtocol = protocols[protocolIndex] || protocols[0];

      if (!selectedProtocol) {
        showToast('error', 'Error', 'No protocol selected');
        return;
      }

      try {
        const response = await fetchAPI('/printers/add', {
          method: 'POST',
          body: JSON.stringify({
            uri: selectedProtocol.uri,
            name: printer.name || 'Network Printer',
            location: printer.location || '',
            make_model: selectedProtocol.type
          })
        });

        if (response.error) {
          throw new Error(response.error);
        }

        showToast('success', 'Printer Added', `${printer.name || 'Printer'} has been added successfully via ${selectedProtocol.type}`);
        loadPrinters();
        showTab('printers');
      } catch (error) {
        showToast('error', 'Error', `Failed to add printer: ${error.message}`);
      }
    }

    // Add Discovered Printer
    async function addDiscoveredPrinter(encodedPrinter) {
      const printer = JSON.parse(decodeURIComponent(encodedPrinter));

      try {
        const response = await fetchAPI('/printers/add', {
          method: 'POST',
          body: JSON.stringify({
            uri: printer.uri,
            name: printer.name || 'Network Printer',
            location: printer.location || '',
            make_model: printer.make_model || ''
          })
        });

        if (response.error) {
          throw new Error(response.error);
        }

        showToast('success', 'Printer Added', `${printer.name || 'Printer'} has been added successfully`);
        loadPrinters();
        showTab('printers');
      } catch (error) {
        showToast('error', 'Error', `Failed to add printer: ${error.message}`);
      }
    }

    // Add Printer Manually
    async function addPrinterManually(event) {
      event.preventDefault();

      const uri = document.getElementById('printer-uri').value;
      const name = document.getElementById('printer-name').value;
      const location = document.getElementById('printer-location').value;

      try {
        const response = await fetchAPI('/printers/add', {
          method: 'POST',
          body: JSON.stringify({ uri, name, location })
        });

        if (response.error) {
          throw new Error(response.error);
        }

        showToast('success', 'Printer Added', `${name} has been added successfully`);
        document.getElementById('manual-add-form').reset();
        loadPrinters();
        showTab('printers');
      } catch (error) {
        showToast('error', 'Error', `Failed to add printer: ${error.message}`);
      }
    }

    // Remove Printer
    async function removePrinter(name) {
      if (!confirm(`Are you sure you want to remove "${name}"?`)) return;

      try {
        const response = await fetchAPI(`/printers/${encodeURIComponent(name)}`, {
          method: 'DELETE'
        });

        if (response.error) {
          throw new Error(response.error);
        }

        showToast('success', 'Printer Removed', `${name} has been removed`);
        loadPrinters();
      } catch (error) {
        showToast('error', 'Error', `Failed to remove printer: ${error.message}`);
      }
    }

    // Test Print
    async function testPrint(printerName) {
      showToast('info', 'Test Print', `Sending test page to ${printerName}...`);

      try {
        const response = await fetchAPI('/printers/test', {
          method: 'POST',
          body: JSON.stringify({ printer_name: printerName })
        });

        if (response.error) {
          throw new Error(response.error);
        }

        showToast('success', 'Test Print Sent', `Test page sent to ${printerName}`);
      } catch (error) {
        showToast('error', 'Error', `Failed to send test print: ${error.message}`);
      }
    }

    // Cancel Job
    async function cancelJob(jobId) {
      try {
        await fetchAPI(`/print/${jobId}`, { method: 'DELETE' });
        showToast('success', 'Job Cancelled', 'Print job has been cancelled');
        loadQueue();
      } catch (error) {
        showToast('error', 'Error', 'Failed to cancel job');
      }
    }

    // Refresh All
    function refreshAll() {
      loadPrinters();
      loadQueue();
      showToast('info', 'Refreshed', 'Data has been refreshed');
    }

    // Settings Tab Functions
    function loadSettingsTab() {
      loadCloudflareConfig();
      loadAboutInfo();
    }

    async function loadCloudflareConfig() {
      try {
        const data = await fetchAPI('/config/remote');
        
        // Update form fields
        document.getElementById('cf-enabled').checked = data.tunnel_enabled || false;
        
        // Show/hide URL display based on active state
        const urlDisplay = document.getElementById('tunnel-url-display');
        const urlValue = document.getElementById('tunnel-url-value');
        
        if (data.tunnel_active && data.tunnel_url) {
          urlDisplay.style.display = 'block';
          urlValue.textContent = data.tunnel_url;
        } else if (data.tunnel_enabled && !data.tunnel_url) {
          urlDisplay.style.display = 'block';
          urlValue.textContent = 'Starting tunnel... (refresh in a few seconds)';
        } else {
          urlDisplay.style.display = 'none';
        }
        
        // Token field - show placeholder if named tunnel is configured
        const tokenInput = document.getElementById('cf-token');
        if (data.tunnel_mode === 'named') {
          tokenInput.placeholder = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
        } else {
          tokenInput.placeholder = 'eyJhIjoiNmU4ZDU3Y... (optional for custom domain)';
        }

        // Update settings status badge
        updateSettingsStatus(data);
        updateSettingsBanner(data);
        
      } catch (error) {
        console.error('Failed to load config:', error);
      }
    }

    function updateSettingsStatus(data) {
      const dot = document.getElementById('settings-status-dot');
      const text = document.getElementById('settings-status-text');
      
      if (data.tunnel_active && data.tunnel_url) {
        dot.className = 'status-dot active';
        text.textContent = data.tunnel_mode === 'quick' ? 'Quick Tunnel Active' : 'Named Tunnel Active';
        text.style.color = 'var(--success-color)';
      } else if (data.tunnel_enabled) {
        dot.className = 'status-dot starting';
        text.textContent = 'Starting...';
        text.style.color = 'var(--warning-color)';
      } else {
        dot.className = 'status-dot inactive';
        text.textContent = 'Disabled';
        text.style.color = 'var(--text-secondary)';
      }
    }

    function updateSettingsBanner(data) {
      const banner = document.getElementById('tunnel-banner');
      const icon = document.getElementById('banner-icon');
      const title = document.getElementById('banner-title');
      const text = document.getElementById('banner-text');
      
      if (data.tunnel_active && data.tunnel_url) {
        banner.className = 'settings-banner success';
        icon.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>`;
        title.textContent = 'ðŸŽ‰ Remote Access Active!';
        const modeText = data.tunnel_mode === 'quick' ? 'Quick Tunnel' : 'Named Tunnel';
        text.innerHTML = `${modeText} is running. Mobile app can connect from anywhere.`;
      } else if (data.tunnel_enabled && !data.tunnel_url) {
        banner.className = 'settings-banner warning';
        icon.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>`;
        title.textContent = 'Starting Tunnel...';
        text.textContent = 'Please wait a few seconds, then refresh this page.';
      } else {
        banner.className = 'settings-banner info';
        icon.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>`;
        title.textContent = 'Remote Access Disabled';
        text.textContent = 'Enable above to print from anywhere with your mobile app.';
      }
    }

    function onTunnelToggle() {
      const enabled = document.getElementById('cf-enabled').checked;
      const urlDisplay = document.getElementById('tunnel-url-display');
      
      if (!enabled) {
        urlDisplay.style.display = 'none';
      }
    }

    async function saveCloudflareConfig(event) {
      event.preventDefault();

      const btn = document.getElementById('save-config-btn');
      btn.disabled = true;

      const enabled = document.getElementById('cf-enabled').checked;
      const token = document.getElementById('cf-token').value.trim();

      try {
        if (enabled) {
          // Start tunnel
          btn.innerHTML = '<div class="spinner" style="width:18px;height:18px;border-width:2px;"></div> Starting tunnel...';

          if (token) {
            // Named tunnel - save config and show restart message
            const response = await fetchAPI('/config/remote', {
              method: 'POST',
              body: JSON.stringify({
                enabled: true,
                tunnel_token: token
              })
            });

            if (response.error) {
              throw new Error(response.error);
            }

            showToast('info', 'Named Tunnel Configured', 'Restart the addon to start the named tunnel with your custom domain.');
          } else {
            // Quick tunnel - start immediately
            const response = await fetchAPI('/tunnel/start', {
              method: 'POST'
            });

            if (response.error) {
              throw new Error(response.error);
            }

            showToast('success', 'Quick Tunnel Starting', 'Your public URL will appear in a few seconds...');

            // Poll for URL
            pollForTunnelUrl();
          }
        } else {
          // Stop tunnel
          btn.innerHTML = '<div class="spinner" style="width:18px;height:18px;border-width:2px;"></div> Stopping tunnel...';

          const response = await fetchAPI('/tunnel/stop', {
            method: 'POST'
          });

          if (response.error) {
            throw new Error(response.error);
          }

          showToast('success', 'Tunnel Stopped', 'Remote access has been disabled.');
        }

        // Reload status after a short delay
        setTimeout(() => {
          loadTunnelStatus();
          loadCloudflareConfig();
        }, 1000);

      } catch (error) {
        showToast('error', 'Error', error.message || 'Failed to update tunnel');
      }

      btn.disabled = false;
      btn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg> Apply Changes`;
    }

    async function pollForTunnelUrl() {
      // Poll for tunnel URL every 2 seconds for up to 30 seconds
      let attempts = 0;
      const maxAttempts = 15;

      const poll = async () => {
        attempts++;
        try {
          const status = await fetchAPI('/tunnel/status');
          if (status.url && status.running) {
            // URL available!
            loadCloudflareConfig();
            loadTunnelStatus();
            showToast('success', 'Tunnel Active!', `Your URL: ${status.url}`);
            return;
          }
        } catch (e) {
          console.error('Poll error:', e);
        }

        if (attempts < maxAttempts) {
          setTimeout(poll, 2000);
        } else {
          // Final check
          loadCloudflareConfig();
          loadTunnelStatus();
        }
      };

      setTimeout(poll, 2000);
    }

    function toggleTokenVisibility() {
      const input = document.getElementById('cf-token');
      const icon = document.getElementById('token-eye-icon');

      if (input.type === 'password') {
        input.type = 'text';
        icon.innerHTML = '<path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/>';
      } else {
        input.type = 'password';
        icon.innerHTML = '<path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>';
      }
    }

    function copyTunnelUrl() {
      const urlValue = document.getElementById('tunnel-url-value').textContent;
      if (urlValue && urlValue !== 'Loading...' && urlValue.startsWith('https://')) {
        navigator.clipboard.writeText(urlValue).then(() => {
          showToast('success', 'URL Copied', 'Tunnel URL copied to clipboard');
        }).catch(() => {
          showToast('error', 'Copy Failed', 'Could not copy URL to clipboard');
        });
      }
    }

    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      const chevron = document.getElementById(`chevron-${sectionId}`);
      
      if (section.style.display === 'none' || !section.style.display) {
        section.style.display = 'block';
        chevron.style.transform = 'rotate(180deg)';
      } else {
        section.style.display = 'none';
        chevron.style.transform = 'rotate(0deg)';
      }
    }

    async function loadAboutInfo() {
      try {
        const data = await fetchAPI('/health');
        document.getElementById('about-version').textContent = data.version || '-';
      } catch (error) {
        document.getElementById('about-version').textContent = '-';
      }
    }

    // Tunnel Status
    let tunnelConfig = null;

    async function loadTunnelStatus() {
      const statusEl = document.getElementById('tunnel-status');
      const indicatorEl = document.getElementById('tunnel-indicator');
      const labelEl = document.getElementById('tunnel-label');

      // Dashboard status card elements
      const remoteIcon = document.getElementById('remote-icon');
      const remoteValue = document.getElementById('remote-status-value');
      const remoteLabel = document.getElementById('remote-status-label');

      try {
        const data = await fetchAPI('/config/remote');
        tunnelConfig = data;

        if (data.tunnel_enabled && data.tunnel_url) {
          // Tunnel is active - Header badge
          indicatorEl.className = 'tunnel-indicator active';
          labelEl.textContent = 'Remote Access';
          statusEl.className = 'tunnel-status active';
          statusEl.title = `Remote: ${data.tunnel_url}`;

          // Dashboard card
          remoteIcon.className = 'icon success';
          remoteValue.textContent = 'Connected';
          remoteValue.style.color = 'var(--success-color)';
          remoteLabel.textContent = 'Cloudflare Tunnel Active';
        } else {
          // Tunnel is not configured - Header badge
          indicatorEl.className = 'tunnel-indicator inactive';
          labelEl.textContent = 'Local Only';
          statusEl.className = 'tunnel-status';
          statusEl.title = 'Cloudflare Tunnel not configured';

          // Dashboard card
          remoteIcon.className = 'icon';
          remoteIcon.style.background = 'rgba(158, 158, 158, 0.15)';
          remoteValue.textContent = 'Not Configured';
          remoteValue.style.color = 'var(--text-secondary)';
          remoteLabel.textContent = 'Enable in Settings';
        }
      } catch (error) {
        // API might not support this endpoint yet
        indicatorEl.className = 'tunnel-indicator inactive';
        labelEl.textContent = 'Local Only';
        statusEl.className = 'tunnel-status';
        statusEl.title = 'Remote access status unavailable';

        // Dashboard card
        remoteIcon.className = 'icon';
        remoteIcon.style.background = 'rgba(158, 158, 158, 0.15)';
        remoteValue.textContent = 'Local Only';
        remoteValue.style.color = 'var(--text-secondary)';
        remoteLabel.textContent = 'Remote Access';
      }
    }

    function showTunnelDetails() {
      if (!tunnelConfig) {
        showToast('info', 'Remote Access',
          'Remote access status is being checked...');
        return;
      }

      if (tunnelConfig.tunnel_enabled && tunnelConfig.tunnel_url) {
        // Copy URL to clipboard
        navigator.clipboard.writeText(tunnelConfig.tunnel_url).then(() => {
          showToast('success', 'Remote Access Active',
            `URL copied! Mobile app can connect via: ${tunnelConfig.tunnel_url}`);
        }).catch(() => {
          showToast('info', 'Remote Access Active',
            `Mobile app can connect via: ${tunnelConfig.tunnel_url}`);
        });
      } else {
        showToast('info', 'Local Network Only',
          'Enable Cloudflare Tunnel in addon Configuration tab for remote mobile access');
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadPrinters();
      loadQueue();
      loadTunnelStatus();

      // Auto-refresh every 30 seconds
      setInterval(() => {
        loadPrinters();
        loadQueue();
      }, 30000);

      // Refresh tunnel status every 60 seconds
      setInterval(loadTunnelStatus, 60000);
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RelayPrint</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <header class="app-header">
      <div class="app-title">
        <svg viewBox="0 0 24 24">
          <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
        </svg>
        <h1>RelayPrint</h1>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="refreshAll()">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
          </svg>
          Refresh
        </button>
      </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="nav-tabs">
      <button class="nav-tab active" data-tab="dashboard">Dashboard</button>
      <button class="nav-tab" data-tab="printers">Printers</button>
      <button class="nav-tab" data-tab="discover">Discover</button>
      <button class="nav-tab" data-tab="queue">Print Queue</button>
    </nav>

    <!-- Dashboard Tab -->
    <section id="dashboard" class="tab-content active">
      <div class="status-grid">
        <div class="status-card">
          <div class="icon primary">
            <svg viewBox="0 0 24 24">
              <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
            </svg>
          </div>
          <div class="value" id="printer-count">-</div>
          <div class="label">Connected Printers</div>
        </div>
        <div class="status-card">
          <div class="icon success">
            <svg viewBox="0 0 24 24">
              <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
            </svg>
          </div>
          <div class="value" id="completed-jobs">-</div>
          <div class="label">Completed Today</div>
        </div>
        <div class="status-card">
          <div class="icon warning">
            <svg viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
          </div>
          <div class="value" id="pending-jobs">-</div>
          <div class="label">Pending Jobs</div>
        </div>
      </div>

      <!-- Recent Printers -->
      <div class="card">
        <div class="card-header">
          <div>
            <h2 class="card-title">Connected Printers</h2>
            <p class="card-subtitle">Printers available for mobile printing</p>
          </div>
          <button class="btn btn-primary" onclick="showTab('discover')">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
            </svg>
            Add Printer
          </button>
        </div>
        <div id="dashboard-printers" class="printer-list">
          <div class="loading-overlay">
            <div class="spinner"></div>
            <span>Loading printers...</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Printers Tab -->
    <section id="printers" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div>
            <h2 class="card-title">All Printers</h2>
            <p class="card-subtitle">Manage your connected printers</p>
          </div>
        </div>
        <div id="all-printers" class="printer-list">
          <div class="loading-overlay">
            <div class="spinner"></div>
            <span>Loading printers...</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Discover Tab -->
    <section id="discover" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div>
            <h2 class="card-title">Discover Network Printers</h2>
            <p class="card-subtitle">Find printers on your local network</p>
          </div>
          <button class="btn btn-primary" onclick="scanForPrinters()" id="scan-btn">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
            Scan Network
          </button>
        </div>
        <div id="discovered-printers" class="discovered-printers">
          <div class="empty-state">
            <svg viewBox="0 0 24 24">
              <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
            <h3>No printers discovered yet</h3>
            <p>Click "Scan Network" to search for printers on your local network</p>
          </div>
        </div>
      </div>

      <!-- Manual Add -->
      <div class="card" style="margin-top: 24px;">
        <div class="card-header">
          <div>
            <h2 class="card-title">Add Printer Manually</h2>
            <p class="card-subtitle">Enter printer details if auto-discovery doesn't find it</p>
          </div>
        </div>
        <form id="manual-add-form" onsubmit="addPrinterManually(event)">
          <div class="form-group">
            <label class="form-label" for="printer-uri">Printer URI</label>
            <input type="text" id="printer-uri" class="form-input" placeholder="ipp://192.168.1.100:631/ipp/print" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="printer-name">Printer Name</label>
            <input type="text" id="printer-name" class="form-input" placeholder="My Printer" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="printer-location">Location (optional)</label>
            <input type="text" id="printer-location" class="form-input" placeholder="Office">
          </div>
          <button type="submit" class="btn btn-success">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
            </svg>
            Add Printer
          </button>
        </form>
      </div>
    </section>

    <!-- Queue Tab -->
    <section id="queue" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div>
            <h2 class="card-title">Print Queue</h2>
            <p class="card-subtitle">Active and recent print jobs</p>
          </div>
          <button class="btn btn-secondary" onclick="loadQueue()">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
            </svg>
            Refresh
          </button>
        </div>
        <div id="print-queue" class="queue-list">
          <div class="empty-state">
            <svg viewBox="0 0 24 24">
              <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
            </svg>
            <h3>No print jobs</h3>
            <p>Print jobs from the mobile app will appear here</p>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>

  <!-- Add Printer Modal -->
  <div class="modal-overlay" id="add-printer-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add Printer</h3>
        <button class="modal-close" onclick="closeModal('add-printer-modal')">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
      </div>
      <div class="modal-body" id="add-printer-modal-body">
        <!-- Dynamic content -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('add-printer-modal')">Cancel</button>
        <button class="btn btn-success" id="confirm-add-printer">Add Printer</button>
      </div>
    </div>
  </div>

  <script>
    // Tab Navigation
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        showTab(tab.dataset.tab);
      });
    });

    function showTab(tabId) {
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
      document.getElementById(tabId).classList.add('active');

      // Load data for the tab
      if (tabId === 'queue') loadQueue();
    }

    // Toast Notifications
    function showToast(type, title, message) {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;

      const icons = {
        success: '<path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>',
        error: '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>',
        info: '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>'
      };

      toast.innerHTML = `
        <svg class="toast-icon" viewBox="0 0 24 24">${icons[type]}</svg>
        <div class="toast-content">
          <div class="toast-title">${title}</div>
          <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
      `;

      container.appendChild(toast);
      setTimeout(() => toast.remove(), 5000);
    }

    // Modal functions
    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // API Functions
    async function fetchAPI(endpoint, options = {}) {
      try {
        const response = await fetch(`/api${endpoint}`, {
          headers: { 'Content-Type': 'application/json', ...options.headers },
          ...options
        });
        return await response.json();
      } catch (error) {
        console.error('API Error:', error);
        throw error;
      }
    }

    // Load Printers
    async function loadPrinters() {
      try {
        const data = await fetchAPI('/printers');
        const printers = data.printers || [];

        document.getElementById('printer-count').textContent = printers.length;

        const renderPrinterList = (containerId, showActions = true) => {
          const container = document.getElementById(containerId);

          if (printers.length === 0) {
            container.innerHTML = `
              <div class="empty-state">
                <svg viewBox="0 0 24 24">
                  <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
                </svg>
                <h3>No printers connected</h3>
                <p>Add a printer to start printing from your mobile device</p>
                <button class="btn btn-primary" onclick="showTab('discover')">Discover Printers</button>
              </div>
            `;
            return;
          }

          container.innerHTML = printers.map(printer => {
            const stateClass = printer.state === 3 ? 'online' : (printer.state === 5 ? 'offline' : 'idle');
            const stateText = printer.state === 3 ? 'Ready' : (printer.state === 5 ? 'Offline' : 'Idle');

            return `
              <div class="printer-item">
                <div class="printer-icon">
                  <svg viewBox="0 0 24 24">
                    <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
                  </svg>
                </div>
                <div class="printer-info">
                  <div class="printer-name">${printer.name}</div>
                  <div class="printer-model">${printer.make_model || 'Unknown Model'}</div>
                </div>
                <div class="printer-status">
                  <span class="status-indicator ${stateClass}"></span>
                  <span class="status-text">${stateText}</span>
                </div>
                ${showActions ? `
                  <div class="printer-actions">
                    <button class="btn btn-icon btn-secondary" onclick="testPrint('${printer.name}')" title="Test Print">
                      <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                        <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
                      </svg>
                    </button>
                    <button class="btn btn-icon btn-danger" onclick="removePrinter('${printer.name}')" title="Remove">
                      <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                      </svg>
                    </button>
                  </div>
                ` : ''}
              </div>
            `;
          }).join('');
        };

        renderPrinterList('dashboard-printers', false);
        renderPrinterList('all-printers', true);

      } catch (error) {
        showToast('error', 'Error', 'Failed to load printers');
      }
    }

    // Load Queue
    async function loadQueue() {
      try {
        const data = await fetchAPI('/queue/status');
        const jobs = data.jobs || [];

        document.getElementById('pending-jobs').textContent = data.pending || 0;
        document.getElementById('completed-jobs').textContent = data.completed || 0;

        const container = document.getElementById('print-queue');

        if (jobs.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <svg viewBox="0 0 24 24">
                <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
              </svg>
              <h3>No print jobs</h3>
              <p>Print jobs from the mobile app will appear here</p>
            </div>
          `;
          return;
        }

        container.innerHTML = jobs.map(job => `
          <div class="queue-item">
            <div class="job-info">
              <div class="job-name">${job.title || 'Untitled'}</div>
              <div class="job-details">${job.printer} - ${job.pages || '?'} pages</div>
            </div>
            <span class="job-status ${job.state}">${job.state}</span>
            ${job.state === 'pending' || job.state === 'printing' ? `
              <button class="btn btn-icon btn-secondary" onclick="cancelJob(${job.id})" title="Cancel">
                <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                  <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
              </button>
            ` : ''}
          </div>
        `).join('');

      } catch (error) {
        document.getElementById('pending-jobs').textContent = '-';
        document.getElementById('completed-jobs').textContent = '-';
      }
    }

    // Scan for Printers
    async function scanForPrinters() {
      const btn = document.getElementById('scan-btn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner" style="width:18px;height:18px;border-width:2px;"></div> Scanning...';

      const container = document.getElementById('discovered-printers');
      container.innerHTML = `
        <div class="loading-overlay">
          <div class="spinner"></div>
          <span>Scanning network for printers...</span>
        </div>
      `;

      try {
        const data = await fetchAPI('/discover');
        const printers = data.printers || [];

        if (printers.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <svg viewBox="0 0 24 24">
                <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
              </svg>
              <h3>No new printers found</h3>
              <p>Make sure your printer is on and connected to the network, then try scanning again</p>
            </div>
          `;
        } else {
          container.innerHTML = printers.map(printer => `
            <div class="discovered-printer">
              <div style="display:flex;align-items:center;margin-bottom:16px;">
                <div class="printer-icon">
                  <svg viewBox="0 0 24 24">
                    <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
                  </svg>
                </div>
                <div class="printer-info">
                  <div class="printer-name">${printer.name || printer.uri}</div>
                  <div class="printer-model">${printer.make_model || printer.uri}</div>
                </div>
              </div>
              <button class="btn btn-success" style="width:100%;" onclick="addDiscoveredPrinter('${encodeURIComponent(JSON.stringify(printer))}')">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
                Add to RelayPrint
              </button>
            </div>
          `).join('');

          showToast('success', 'Scan Complete', `Found ${printers.length} printer(s)`);
        }
      } catch (error) {
        container.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
            </svg>
            <h3>Scan failed</h3>
            <p>Unable to scan network. Please try again.</p>
          </div>
        `;
        showToast('error', 'Error', 'Failed to scan for printers');
      }

      btn.disabled = false;
      btn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
        </svg>
        Scan Network
      `;
    }

    // Add Discovered Printer
    async function addDiscoveredPrinter(encodedPrinter) {
      const printer = JSON.parse(decodeURIComponent(encodedPrinter));

      try {
        const response = await fetchAPI('/printers/add', {
          method: 'POST',
          body: JSON.stringify({
            uri: printer.uri,
            name: printer.name || 'Network Printer',
            location: printer.location || '',
            make_model: printer.make_model || ''
          })
        });

        if (response.error) {
          throw new Error(response.error);
        }

        showToast('success', 'Printer Added', `${printer.name || 'Printer'} has been added successfully`);
        loadPrinters();
        showTab('printers');
      } catch (error) {
        showToast('error', 'Error', `Failed to add printer: ${error.message}`);
      }
    }

    // Add Printer Manually
    async function addPrinterManually(event) {
      event.preventDefault();

      const uri = document.getElementById('printer-uri').value;
      const name = document.getElementById('printer-name').value;
      const location = document.getElementById('printer-location').value;

      try {
        const response = await fetchAPI('/printers/add', {
          method: 'POST',
          body: JSON.stringify({ uri, name, location })
        });

        if (response.error) {
          throw new Error(response.error);
        }

        showToast('success', 'Printer Added', `${name} has been added successfully`);
        document.getElementById('manual-add-form').reset();
        loadPrinters();
        showTab('printers');
      } catch (error) {
        showToast('error', 'Error', `Failed to add printer: ${error.message}`);
      }
    }

    // Remove Printer
    async function removePrinter(name) {
      if (!confirm(`Are you sure you want to remove "${name}"?`)) return;

      try {
        const response = await fetchAPI(`/printers/${encodeURIComponent(name)}`, {
          method: 'DELETE'
        });

        if (response.error) {
          throw new Error(response.error);
        }

        showToast('success', 'Printer Removed', `${name} has been removed`);
        loadPrinters();
      } catch (error) {
        showToast('error', 'Error', `Failed to remove printer: ${error.message}`);
      }
    }

    // Test Print
    async function testPrint(printerName) {
      showToast('info', 'Test Print', `Sending test page to ${printerName}...`);

      try {
        const response = await fetchAPI('/printers/test', {
          method: 'POST',
          body: JSON.stringify({ printer_name: printerName })
        });

        if (response.error) {
          throw new Error(response.error);
        }

        showToast('success', 'Test Print Sent', `Test page sent to ${printerName}`);
      } catch (error) {
        showToast('error', 'Error', `Failed to send test print: ${error.message}`);
      }
    }

    // Cancel Job
    async function cancelJob(jobId) {
      try {
        await fetchAPI(`/print/${jobId}`, { method: 'DELETE' });
        showToast('success', 'Job Cancelled', 'Print job has been cancelled');
        loadQueue();
      } catch (error) {
        showToast('error', 'Error', 'Failed to cancel job');
      }
    }

    // Refresh All
    function refreshAll() {
      loadPrinters();
      loadQueue();
      showToast('info', 'Refreshed', 'Data has been refreshed');
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadPrinters();
      loadQueue();

      // Auto-refresh every 30 seconds
      setInterval(() => {
        loadPrinters();
        loadQueue();
      }, 30000);
    });
  </script>
</body>
</html>
